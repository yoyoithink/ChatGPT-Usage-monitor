# ChatGPT 使用量监控（Tampermonkey / 油猴脚本）

一个 Tampermonkey 用户脚本，通过拦截 ChatGPT 网页端请求，对**不同模型的使用量进行本地统计与分桶展示**（GPT-5.x Auto/Instant、GPT-5.x Thinking、GPT-5.x Thinking Mini、GPT-4.x、o3、o4-mini）。

> **说明**
> 本脚本是**浏览器本地的非官方统计**，
> **不等同于官方额度**，仅用于参考分析。

---

## 功能特性

### 核心功能

* **按桶统计**模型用量，带进度条与告警阈值
* **滚动窗口 / 自然窗口**

  * 例如 3 小时滚动
  * 自然日 / 自然周
* **请求状态跟踪**

  * dispatched / completed / failed
  * 在 **请求发出时即计数**
* **分析面板**

  * 7 天 / 30 天总览
  * 每日趋势
  * 桶占比分布
  * 每日明细表
* **用量数据导入 / 导出（JSON）**
* **一键清空本地数据**
* **UI 风格对齐 ChatGPT**（支持深色模式）
* **中英文切换**，自动跟随 ChatGPT 页面语言

### 体验优化

* **内联模式**

  * 检测到模型切换按钮时，在旁边插入“用量”按钮
* **悬浮模式**

  * 无锚点时显示可拖拽、可缩放的悬浮面板
* **快捷键**

  * `Ctrl / Cmd + I`：打开 / 关闭面板
  * `Esc`：关闭面板

---

## 安装方式

### 方式一：脚本平台安装（推荐）

1. 安装 **Tampermonkey**
2. 打开脚本发布页（如 Greasy Fork）
3. 点击 **Install / 安装**

### 方式二：手动安装

1. 安装 **Tampermonkey**
2. 新建用户脚本
3. 粘贴完整脚本代码
4. 保存后访问 `https://chatgpt.com/`

---

## 使用方法

1. 打开 `https://chatgpt.com/`
2. 点击 **用量**

   * 内联模式：按钮在模型选择器旁
   * 悬浮模式：点击悬浮按钮展开
3. 面板标签：

   * **用量**：实时统计与重置倒计时
   * **分析**：7 / 30 天统计与分布
   * **调试**：请求事件日志（可选）

### 油猴菜单命令

* 重置面板位置
* 导出用量数据
* 导入用量数据
* 清空用量数据

---

## 桶与模型映射说明

脚本根据请求体中的 `model` / `model_slug`，
通过 `MODEL_BUCKET_MAP` 映射到对应桶。

**默认桶**

* GPT-5.x Auto / Instant
* GPT-5.x Thinking
* GPT-5.x Thinking Mini
* GPT-4.x
* o3
* o4-mini

> 可在 `MODEL_BUCKET_MAP` 中为任意桶追加新的模型标识。

---

## 数据与存储

* **仅存储在本地浏览器**
* 使用 Tampermonkey 存储接口
* 数据保留 **45 天**
* 导出为 JSON 快照

---

## 隐私声明

* 不上传任何数据
* 所有记录仅保存在本地
* 仅拦截 `fetch` 请求以读取统计所需的最小元信息

> 若无法接受请求拦截，请勿安装本脚本。

---

## 兼容性

* 站点：`https://chatgpt.com/*`
* 依赖：Tampermonkey 或兼容管理器
* ChatGPT 前端频繁更新，选择器可能需要维护

---

## 常见问题

### 为什么和官方额度不一致？

这是**非官方、本地估算**。重试、失败、取消或前端变动都会产生偏差。

### 失败的消息也会计数吗？

会。请求在 **发送时即计数**，之后尽量更新状态。

### 如何恢复面板默认位置？

使用油猴菜单中的 **重置位置**。

---

## 开发说明

* 单文件用户脚本
* 主要模块：

  * UI 与主题
  * 数据存储与迁移
  * 桶逻辑与统计分析
  * `fetch` 请求拦截与去重

---

## 许可证

MIT License

---

## 免责声明

本项目与 OpenAI **无任何隶属关系**。
统计结果基于浏览器侧观测请求，仅为尽力估算，风险自负。
